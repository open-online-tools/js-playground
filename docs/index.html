<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JS Playground</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --editor-bg: #1e1e1e;
        --console-bg: #242424;
        --console-header-bg: #3c3c3c;
        --border-color: #454545;
        --text-color: #d4d4d4;
        --log-color: #d4d4d4;
        --warn-color: #dcdcaa;
        --error-color: #f48771;
        --info-color: #9cdcfe;
        --button-bg: #0e639c;
        --button-hover: #1177bb;
        --timestamp-color: #6a9955;
      }

      html,
      body {
        height: 100%;
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
          sans-serif;
        background: var(--editor-bg);
        color: var(--text-color);
      }

      .app-container {
        display: flex;
        flex-direction: column;
        min-height: 200vh;
      }

      .editor-panel {
        position: relative;
        height: 100vh;
        min-height: 100vh;
      }

      #editor {
        width: 100%;
        height: 100%;
      }

      .run-button {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 100;
        background: var(--button-bg);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition:
          background-color 0.2s,
          transform 0.1s;
      }

      .run-button:hover {
        background: var(--button-hover);
      }

      .run-button:active {
        transform: scale(0.98);
      }

      .run-button svg {
        width: 18px;
        height: 18px;
        fill: currentColor;
      }

      .console-panel {
        height: 100vh;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: var(--console-bg);
        border-top: 1px solid var(--border-color);
      }

      .console-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: var(--console-header-bg);
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
      }

      .console-title {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-color);
      }

      .console-actions {
        display: flex;
        gap: 8px;
      }

      .console-btn {
        background: transparent;
        border: none;
        color: var(--text-color);
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        opacity: 0.8;
        transition: opacity 0.2s;
      }

      .console-btn:hover {
        opacity: 1;
        background: rgba(255, 255, 255, 0.1);
      }

      .console-output {
        flex: 1;
        overflow-y: auto;
        padding: 8px 0;
        font-family:
          'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas,
          'Courier New', monospace;
        font-size: 12px;
        line-height: 1.4;
      }

      .console-entry {
        padding: 4px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: flex-start;
        gap: 8px;
      }

      .console-entry:hover {
        background: rgba(255, 255, 255, 0.03);
      }

      .console-entry.log {
        color: var(--log-color);
      }

      .console-entry.warn {
        color: var(--warn-color);
        background: rgba(220, 220, 170, 0.1);
      }

      .console-entry.error {
        color: var(--error-color);
        background: rgba(244, 135, 113, 0.1);
      }

      .console-entry.info {
        color: var(--info-color);
      }

      .console-icon {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
        margin-top: 2px;
      }

      .console-message {
        flex: 1;
        word-break: break-word;
        white-space: pre-wrap;
      }

      .console-timestamp {
        color: var(--timestamp-color);
        font-size: 11px;
        flex-shrink: 0;
      }

      .console-entry.result {
        color: #569cd6;
      }

      .console-entry.result .console-icon::before {
        content: '<';
      }

      .object-preview {
        color: #9cdcfe;
      }

      .string-value {
        color: #ce9178;
      }

      .number-value {
        color: #b5cea8;
      }

      .boolean-value {
        color: #569cd6;
      }

      .null-value {
        color: #569cd6;
      }

      .undefined-value {
        color: #6a6a6a;
      }

      /* Tablet (portrait) - vertical split */
      @media screen and (min-width: 768px) and (orientation: portrait) {
        .app-container {
          min-height: 100vh;
          height: 100vh;
        }

        .editor-panel {
          height: 50vh;
          min-height: 50vh;
        }

        .console-panel {
          height: 50vh;
          min-height: 50vh;
          border-top: 1px solid var(--border-color);
        }
      }

      /* Tablet (landscape) and Desktop - horizontal split */
      @media screen and (min-width: 768px) and (orientation: landscape),
        screen and (min-width: 1024px) {
        .app-container {
          flex-direction: row;
          min-height: 100vh;
          height: 100vh;
        }

        .editor-panel {
          width: 50%;
          height: 100vh;
          min-height: 100vh;
        }

        .console-panel {
          width: 50%;
          height: 100vh;
          min-height: 100vh;
          border-top: none;
          border-left: 1px solid var(--border-color);
        }
      }

      /* Loading indicator */
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-color);
        font-size: 16px;
      }

      .loading::after {
        content: '';
        width: 20px;
        height: 20px;
        margin-left: 12px;
        border: 2px solid var(--text-color);
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <div class="editor-panel">
        <div id="editor" class="loading">Loading editor...</div>
        <button
          class="run-button"
          onclick="runCode()"
          title="Run code (Ctrl+Enter)"
        >
          <svg viewBox="0 0 24 24">
            <path d="M8 5v14l11-7z" />
          </svg>
          Run
        </button>
      </div>
      <div class="console-panel" id="console-panel">
        <div class="console-header">
          <span class="console-title">Console</span>
          <div class="console-actions">
            <button
              class="console-btn"
              onclick="clearConsole()"
              title="Clear console"
            >
              Clear
            </button>
          </div>
        </div>
        <div class="console-output" id="console-output"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <script>
      // Default example code using use-m
      const defaultCode = `// JS Playground - using use-m for dynamic imports
// See: https://github.com/link-foundation/use-m

const { use } = await import('https://esm.sh/use-m');

// Load lodash-es with version pinning for security
const _ = await use('lodash-es@4.17.21');

console.log('Lodash loaded successfully!');

// Math operations
console.log('_.add(1, 2) =', _.add(1, 2));
console.log('_.multiply(3, 4) =', _.multiply(3, 4));

// Array manipulation examples
const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
console.log('Original array:', numbers);
console.log('Chunk into pairs:', _.chunk(numbers, 2));
console.log('First 3 elements:', _.take(numbers, 3));
console.log('Sum:', _.sum(numbers));

// Collection operations
const users = [
  { name: 'Alice', age: 25 },
  { name: 'Bob', age: 30 },
  { name: 'Charlie', age: 35 }
];
console.log('Users:', users);
console.log('Names only:', _.map(users, 'name'));
console.log('Find Bob:', _.find(users, { name: 'Bob' }));
`;

      let editor = null;

      // Initialize Monaco Editor
      require.config({
        paths: {
          vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs',
        },
      });

      require(['vs/editor/editor.main'], function () {
        const editorContainer = document.getElementById('editor');
        editorContainer.classList.remove('loading');
        editorContainer.textContent = '';

        editor = monaco.editor.create(editorContainer, {
          value: defaultCode,
          language: 'javascript',
          theme: 'vs-dark',
          minimap: { enabled: false },
          fontSize: 14,
          lineNumbers: 'on',
          wordWrap: 'on',
          automaticLayout: true,
          scrollBeyondLastLine: false,
          padding: { top: 16, bottom: 16 },
          tabSize: 2,
          insertSpaces: true,
        });

        // Add keyboard shortcut for running code
        editor.addCommand(
          monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter,
          function () {
            runCode();
          }
        );
      });

      // Console output element
      const consoleOutput = document.getElementById('console-output');
      const consolePanel = document.getElementById('console-panel');

      // Format value for display
      function formatValue(value, depth = 0) {
        if (depth > 3) return '...';

        if (value === null) {
          return '<span class="null-value">null</span>';
        }
        if (value === undefined) {
          return '<span class="undefined-value">undefined</span>';
        }
        if (typeof value === 'string') {
          return `<span class="string-value">"${escapeHtml(value)}"</span>`;
        }
        if (typeof value === 'number') {
          return `<span class="number-value">${value}</span>`;
        }
        if (typeof value === 'boolean') {
          return `<span class="boolean-value">${value}</span>`;
        }
        if (typeof value === 'function') {
          return `<span class="object-preview">[Function: ${value.name || 'anonymous'}]</span>`;
        }
        if (value instanceof Error) {
          return `<span class="error">${escapeHtml(value.stack || value.message)}</span>`;
        }
        if (Array.isArray(value)) {
          if (value.length === 0)
            return '<span class="object-preview">[]</span>';
          if (depth >= 2)
            return `<span class="object-preview">Array(${value.length})</span>`;
          const items = value
            .slice(0, 10)
            .map((v) => formatValue(v, depth + 1))
            .join(', ');
          const more =
            value.length > 10 ? `, ... ${value.length - 10} more` : '';
          return `<span class="object-preview">[${items}${more}]</span>`;
        }
        if (typeof value === 'object') {
          try {
            const keys = Object.keys(value);
            if (keys.length === 0)
              return '<span class="object-preview">{}</span>';
            if (depth >= 2) return `<span class="object-preview">{...}</span>`;
            const pairs = keys
              .slice(0, 5)
              .map((k) => `${k}: ${formatValue(value[k], depth + 1)}`)
              .join(', ');
            const more = keys.length > 5 ? `, ...` : '';
            return `<span class="object-preview">{${pairs}${more}}</span>`;
          } catch {
            return '<span class="object-preview">[Object]</span>';
          }
        }
        return escapeHtml(String(value));
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Get icon SVG for console entry type
      function getIcon(type) {
        const icons = {
          log: '',
          info: '<svg class="console-icon" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 16v-4M12 8h.01"/></svg>',
          warn: '<svg class="console-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 9v4m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" fill="none" stroke="currentColor" stroke-width="2"/></svg>',
          error:
            '<svg class="console-icon" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M15 9l-6 6M9 9l6 6" stroke="currentColor" stroke-width="2"/></svg>',
        };
        return icons[type] || '';
      }

      // Add entry to console
      function addConsoleEntry(type, args) {
        const entry = document.createElement('div');
        entry.className = `console-entry ${type}`;

        const icon = getIcon(type);
        const timestamp = new Date().toLocaleTimeString('en-US', {
          hour12: false,
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
        });

        const message = args.map((arg) => formatValue(arg, 0)).join(' ');

        entry.innerHTML = `
          ${icon ? icon : '<span class="console-icon"></span>'}
          <span class="console-message">${message}</span>
          <span class="console-timestamp">${timestamp}</span>
        `;

        consoleOutput.appendChild(entry);
        consoleOutput.scrollTop = consoleOutput.scrollHeight;
      }

      // Clear console
      function clearConsole() {
        consoleOutput.innerHTML = '';
      }

      // Scroll to console (for mobile)
      function scrollToConsole() {
        const isMobile = window.innerWidth < 768;
        if (isMobile) {
          consolePanel.scrollIntoView({ behavior: 'smooth' });
        }
      }

      // Run the code
      async function runCode() {
        if (!editor) return;

        const code = editor.getValue();

        // Add execution marker
        addConsoleEntry('info', ['Executing code...']);

        // Scroll to console on mobile
        scrollToConsole();

        // Create a sandboxed environment for console methods
        const sandboxConsole = {
          log: (...args) => addConsoleEntry('log', args),
          info: (...args) => addConsoleEntry('info', args),
          warn: (...args) => addConsoleEntry('warn', args),
          error: (...args) => addConsoleEntry('error', args),
          clear: () => clearConsole(),
        };

        try {
          // Wrap code in async function to support top-level await
          const wrappedCode = `
            return (async function(console) {
              ${code}
            })(sandboxConsole);
          `;

          const fn = new Function('sandboxConsole', wrappedCode);
          const result = await fn(sandboxConsole);

          // Show return value if any
          if (result !== undefined) {
            addConsoleEntry('result', ['<-', result]);
          }
        } catch (error) {
          addConsoleEntry('error', [
            error.stack || error.message || String(error),
          ]);
        }
      }
    </script>
  </body>
</html>
